# v0.12.0 리플레이 내보내기 및 잡 UI 설계

## 1. 목적
- 리플레이 뷰어에서 MP4/썸네일 내보내기 요청을 생성하고, 진행률/로그/결과를 직관적으로 보여준다.
- 별도 "작업" 목록 화면을 제공해 여러 잡의 상태를 한눈에 확인하고 다운로드/실패 원인 확인을 지원한다.
- WebSocket 이벤트(`job.progress/completed/failed`)를 UI 상태와 동기화한다.

## 2. 범위
- Replay Viewer 페이지 버튼/드로어 추가 및 상태 관리.
- 잡 목록 페이지 라우팅/테이블/필터/다운로드 링크.
- WebSocket 클라이언트 훅(`useJobSocket`)과 REST API 클라이언트(`features/jobs/api.ts`).
- 기본 스타일(진행률 라벨, 테이블/드로어) 보완.

## 3. 외부 동작
### 3.1 사용자 흐름
- 리플레이 뷰어에서 "MP4 내보내기" 또는 "썸네일 생성" 클릭 → 백엔드에 POST → 즉시 `jobId`를 받아 JobDrawer 오픈.
- JobDrawer
  - 진행률 바 + 단계/메시지 로그.
  - 완료 시 다운로드 버튼(`GET /api/jobs/{jobId}/result`).
  - 실패 시 오류 코드/메시지 표시.
- Jobs 페이지(`/jobs`)
  - 테이블 컬럼: ID, 타입, 상태, 진행률, 리플레이 ID, 생성/시작/종료 시각, 오류/결과 링크.
  - 필터: 상태(`QUEUED/RUNNING/SUCCEEDED/FAILED/CANCELLED`), 타입(`REPLAY_EXPORT_MP4/REPLAY_THUMBNAIL`).
  - 진행 중 항목은 WebSocket으로 자동 업데이트, 완료 시 다운로드 링크 활성화.

### 3.2 WebSocket 이벤트 처리
- `useJobSocket`이 `/ws/jobs`에 연결해 이벤트를 핸들러에 전달.
- 핸들러는 `jobId` 키를 기준으로:
  - `job.progress`: 진행률/단계/로그 업데이트.
  - `job.completed`: 상태를 `SUCCEEDED`로 설정하고 다운로드 링크를 표시.
  - `job.failed`: 상태를 `FAILED`로 설정하고 오류 메시지 표시.
- 브라우저가 WebSocket을 지원하지 않거나 연결 실패 시 자동 재시도하지 않고, REST 폴백(상세 조회/목록 갱신)으로 상태를 확보한다.

## 4. 내부 구성
### 4.1 주요 컴포넌트/페이지
- `ReplayViewerPage`
  - 새 export 요청 핸들러(`requestMp4Export`, `requestThumbnailExport`)와 `fetchJob` 폴백 호출 포함.
  - JobDrawer 상태(`activeJob`, `progressLog`)를 관리하고 WebSocket 이벤트로 갱신.
- `JobDrawer`
  - 진행률 바, 단계/메시지 로그, 완료 다운로드 링크, 실패 메시지 렌더링.
- `JobsPage`
  - 최초 진입 시 목록 API 호출(`fetchJobs`), 필터 변경 시 재호출.
  - WebSocket 이벤트로 리스트 내 특정 행을 업데이트.
  - 테스트(`JobsPage.test.tsx`)에서 렌더/이벤트 적용 여부 검증.
- `useJobSocket`
  - WebSocket 미지원 브라우저에서 null을 반환하는 가드 제공, 핸들러 ref로 최신 콜백 유지.

### 4.2 타입/상수
- `shared/types/job.ts`에 `JobStatus`, `JobType`, API 응답 타입을 정의해 프런트 전역에서 일관성을 유지한다.
- 진행률 단계 표시 문자열은 서버 `phase` 그대로 노출해 디버깅 친화성을 유지한다.

### 4.3 스타일
- `index.css`에서 테이블/드로어 기본 여백과 진행률 라벨(`.progress-label`) 추가.
- 모바일 뷰에서도 드로어가 화면 폭을 덮도록 `max-width` 조정.

## 5. 테스트 전략
- `JobsPage.test.tsx`: 목록 렌더링, 필터와 진행률 바 표시를 스냅샷/DOM 쿼리로 확인.
- `ReplayViewerPage` 기존 테스트: WebSocket 훅이 없는 환경에서도 버튼/기본 상태 렌더가 깨지지 않는지 확인.
- 수동 확인: 실제 워커 실행 후 잡 생성 → 드로어/목록에서 진행률이 실시간으로 올라가고 완료 시 다운로드 링크가 동작하는지 점검.

## 6. 호환성/확장
- 이벤트 타입/상태 문자열을 백엔드와 동일하게 유지해 후속 버전에서도 타입 정의 변경 없이 동작한다.
- 향후 취소/재시도 버튼을 추가할 때도 동일 Job API/소켓 이벤트를 확장하는 방향을 우선한다.
- 다국어 지원 필요 시 UI 문자열을 i18n 리소스로 분리할 수 있도록 현재 하드코딩된 문구를 정리할 계획을 남긴다.
