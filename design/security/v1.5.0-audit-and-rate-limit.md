# v1.5.0 보안/감사 설계 – 감사 로그 및 레이트리밋

## 1. 목표
- 민감/관리자 액션이 **append-only 감사 로그**에 모두 남도록 한다.
- 로그인/채팅/웹소켓 연결에 대한 **기본 레이트리밋**과 관측 지표를 제공한다.
- OAuth 로그인 시 **동의/스코프 기록**을 남겨 위임 범위를 추적한다.

## 2. 감사 로그 설계
- 저장 위치: DB `audit_logs` 테이블 (JPA `AuditLog` 엔티티).
- 정책: 생성만 허용(updatable=false), 삭제/수정 API 없음.
- 필드: `id`, `action`, `actor_id`, `target_type`, `target_id`, `detail`, `occurred_at`(Asia/Seoul).
- 기록 경로: `AuditLogService.recordAdminAction` → 관리 서비스에서 호출.
- 적용 범위 (v1.5.0):
  - 관리자 제재(`USER_MODERATION`) 액션은 모두 감사 로그에 남긴다.
  - 추후 민감 액션 추가 시 동일 서비스에서 호출하도록 확장.
- 로그/메트릭: 감사 기록 성공 시 info 로그 `[AUDIT]` 출력.

## 3. OAuth 동의/스코프
- 기본 요구 스코프: `profile email` (프로퍼티 `auth.oauth.required-scopes`로 조정 가능).
- 최초 OAuth 로그인 시 `OAuthConsentService`가 `oauth_consents` 테이블에 동의 스냅샷을 append-only로 기록.
- 재로그인 시 기존 동의에 요구 스코프가 모두 포함되어 있지 않으면 새 레코드를 추가해 추적성을 유지.

## 4. 레이트리밋 정책
- 구현: 고정 윈도우 카운터(`RateLimitService`), Micrometer 카운터 `security.rate_limit`에 result 태그 기록.
- 설정: `security.rate-limit.<category>.limit/window` (Duration 바인딩, 기본값 application.properties 참고).
- 카테고리별 키
  - `login`: `HttpServletRequest.getRemoteAddr()` 기준 IP당 제한.
  - `chat`: 인증된 사용자 ID 기준 REST 채팅 전송 제한.
  - `websocket`: 핸드셰이크 시 원격 IP 기준 제한 (차단 시 429).
- 차단 시 응답
  - REST: HTTP 429 + 메시지 "요청이 너무 많습니다. 잠시 후 다시 시도하세요."
  - WS: 핸드셰이크 단계에서 429 설정 후 거부.

## 5. 인증 일관성
- REST 보호 엔드포인트: Spring Security JWT 필터 + 레이트리밋 이후 처리.
- WS: `WebSocketAuthHandshakeInterceptor`에서 동일 JWT 파싱 로직 + 레이트리밋 → 인증 실패 시 핸드셰이크 거부.
- 채팅 REST/WS 모두 인증이 필요한 엔드포인트로 유지.

## 6. 테스트 전략
- **감사**: 관리자 제재 수행 시 `audit_logs` 레코드 추가 여부 검증.
- **레이트리밋**: 로그인 3회 연속 요청 시 3번째가 429인지 확인.
- **REST/WS 인증 일관성**: 토큰 없이 REST 채팅 요청이 401, 유효 토큰으로 WS 핸드셰이크 성공/잘못된 토큰은 실패.

## 7. 운영 메모
- 레이트리밋 값 조정은 환경 변수(`RATE_LIMIT_*`)로 덮어쓰며, 긴급 차단 시 limit를 0으로 두어 즉시 차단 가능.
- 감사/동의 테이블은 append-only이므로 정기 백업/아카이빙을 통해 용량 관리.
