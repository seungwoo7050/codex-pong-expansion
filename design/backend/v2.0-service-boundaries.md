# v2.0 Service Boundaries

Target version: **v2.0** (single minor version scope per change set).

## Goals
- Establish hybrid MSA with real data ownership per service.
- Keep external REST/WS contracts stable behind `edge-api`.
- Route internal sync calls through gRPC with trace continuity.

## Services and Ownership
### edge-api
- Single external REST ingress and strangler host for legacy modules.
- Maps external envelopes to gRPC calls; enforces error mapping and traceId
  propagation.
- Holds only legacy schemas; new domains must be extracted.

### identity-service
- Owns `identity_*` schema and access tokens.
- Exposes gRPC for token validation, user profile lookup, and verification key
  retrieval (`GetKeySet`) for local validation in edge-api and realtime-gateway.
- Provides JWKS-style cacheable keys; no runtime DB access from other services.

### match-service
- Owns `match_*` schema, match results, and outbox for `MatchEnded` events.
- Receives `PersistMatchResult` calls from shard; provides history reads via
  `QueryMatchHistory` for edge-api.
- Authoritative producer for match lifecycle events; no external SQL consumers.

### chat-service
- Owns `chat_*` schema for channels/messages/moderation state.
- gRPC operations for sending and listing messages.
- Moderation signals stay within chat-service; downstream consumers (e.g.
  abuse pipeline in v2.1+) use events, not cross-service queries.

### realtime components
- `realtime-gateway` validates tokens locally using identity-service keys.
- `game-session-shard` persists results via match-service gRPC with traceId
  continuity; no direct DB writes to `match_*` tables.

## Interaction Model
- **Authentication:** edge-api and realtime-gateway fetch key sets from
  identity-service and validate tokens locally. TraceContext includes caller for
  observability.
- **Match flow:** client -> edge-api (REST) -> realtime gateway/shard; shard
  calls match-service `PersistMatchResult`; edge-api reads history via
  `QueryMatchHistory`.
- **Chat flow:** client -> edge-api (REST) -> chat-service gRPC for posting and
  listing messages.
- **Data boundaries:** No cross-service DB queries. Derived data uses gRPC or
  (from v2.1) events.

## Operational Notes
- Each service must ship its own migrations and DB credentials.
- TraceId must be propagated end-to-end (edge-api -> services -> DB/outbox).
- Feature flags live in edge-api to route legacy vs extracted paths during
  strangler rollout.
