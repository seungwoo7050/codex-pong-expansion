# v0.11.0 리플레이 녹화 및 저장 설계

## 1. 목적
- 실시간 경기 종료 후 동일한 상태를 재생할 수 있도록 **이벤트 스트림 기반 리플레이**를 제공한다.
- 저장·조회·다운로드 흐름을 명확히 정의해 이후 리플레이 내보내기(v0.12.0)로 확장 가능한 기반을 만든다.

## 2. 범위
- 경기 종료 시점의 스냅샷 시퀀스를 JSONL 파일로 저장한다.
- 리플레이 메타데이터 테이블/엔티티 추가 및 소유자 권한 검증.
- REST API (목록/상세/매치 기준 조회/이벤트 스트리밍) 구현.
- Docker Compose에 로컬 영속 볼륨 추가 및 사용자당 보존 정책 적용.
- v0.11.0에서는 사후 기능만 다루며 **신규 WebSocket 이벤트는 추가하지 않는다**.

## 3. 외부 동작
### 3.1 API 계약
- `GET /api/replays?page={n}&size={m}`: 현재 사용자 소유 리플레이 페이지 반환 (생성일 내림차순 고정).
- `GET /api/replays/{replayId}`: 메타데이터+다운로드 경로 반환. 소유자만 접근 가능.
- `GET /api/matches/{matchId}/replay`: 매치 ID 기준 메타데이터 조회. 소유자만 접근 가능.
- `GET /api/replays/{replayId}/events`: **옵션 A: 백엔드 스트리밍** 고정. `application/x-ndjson`으로 JSONL 이벤트 파일 스트림을 제공하며, `Content-Disposition`으로 파일 이름을 노출한다.

### 3.2 권한/정합성
- 기본 정책: **소유자만 조회 가능**. 관리자 예외는 후속 버전에서 정의한다.
- 이벤트 스트림과 메타데이터는 동일한 스토리지 URI를 사용하며, 체크섬으로 무결성을 확인한다.

## 4. 내부 구조
### 4.1 DB/엔티티
- `replays` 테이블 (PK `replay_id`): `match_id` FK(GameResult), `owner_user_id` FK(User), `created_at`, `duration_ms`, `event_format`(JSONL_V1), `storage_uri`, `checksum`.
- `Replay` 엔티티는 위 필드를 보관하며 `@PrePersist`로 `createdAt`을 `Asia/Seoul` 기준으로 채운다.

### 4.2 녹화 흐름
- `ReplayService`가 메모리 버퍼(`RecordingBuffer`)를 관리한다.
  - `startRecording(GameRoom)`: 경기 생성 시 버퍼 생성 + 초기 스냅샷 기록.
  - `appendSnapshot(roomId, snapshot)`: 틱마다 상대 오프셋(ms)과 함께 이벤트 추가.
  - `completeRecording(room, result)`: 버퍼를 JSONL 파일로 직렬화 → SHA-256 체크섬 계산 → 두 플레이어 소유 리플레이 행 생성 → 사용자당 보존 정책 적용.
- `GameRoomService` 연동:
  - `createRoom` 시 `startRecording` 호출.
  - `runTick`에서 스냅샷 계산 직후 `appendSnapshot` 호출.
  - 종료 시 `completeRecording` 호출 후 방 제거.

### 4.3 이벤트 포맷 (JSONL_V1)
- 각 라인: `{ "offsetMs": <long>, "snapshot": <GameSnapshot> }`.
- `offsetMs`: 녹화 시작 기준 경과 시간(ms).
- `snapshot`: 기존 실시간 전송 포맷 그대로(`roomId`, 좌표, 점수, `finished` 포함).

### 4.4 보존/스토리지
- 기본 스토리지 경로: `${user.dir}/build/replays` (로컬/CI 기본값, 권한 이슈 없는 워킹 디렉터리 내부). Docker Compose에서는
  `REPLAY_STORAGE_PATH=/data/replays`로 오버라이드하여 named volume을 사용한다.
- 보존 정책: `REPLAY_RETENTION_MAX_PER_USER`(기본 20) 초과 시 가장 오래된 리플레이부터 DB 삭제 후 참조가 없는 파일만 제거.

## 5. 테스트 전략
- `ReplayControllerTest`: 소유자 토큰으로 목록/상세/매치 조회/이벤트 스트림을 검증, 외부 사용자 접근 차단을 간접적으로 확인.
- 기존 WebSocket/매칭 테스트는 변경하지 않고 회귀 실행으로 기존 흐름이 깨지지 않는지 확인한다.

## 6. 마이그레이션/호환성
- `spring.jpa.hibernate.ddl-auto=update`로 신규 테이블이 자동 생성된다. 운영 환경에서는 명시적 마이그레이션 스크립트를 병행한다.
- JSONL 포맷은 이후 v0.12.0 내보내기 파이프라인에서 그대로 재사용하며, 포맷 버전은 `eventFormat` 필드로 명시한다.
