# v0.7.0 백엔드 설계 – 토너먼트/이벤트

## 1. 개요
- 목표: 단일 제거 토너먼트 엔티티와 등록/시작/진행/완료 흐름을 제공한다.
- 범위: v0.7.0에 한정하며, 기존 게임 방/매칭 서비스(GameRoomService)와 연동해 매치 roomId를 생성한다.
- 아웃풋: 토너먼트 REST API, WebSocket 알림, 매치 결과 반영 로직, 통합 테스트.

## 2. 도메인 모델
- `Tournament`
  - 필드: id, name, maxParticipants(4/8/16), status(REGISTRATION/IN_PROGRESS/COMPLETED), creator(User), createdAt/startedAt/completedAt.
- `TournamentParticipant`
  - 필드: id, tournament(FK), user(FK), seed(가입 순서), joinedAt.
- `TournamentMatch`
  - 필드: id, tournament(FK), roundNumber, position, participantA/B(FK), winner(FK), status(PENDING/READY/COMPLETED), roomId, scoreA/B, completedAt.
- 상태 전이
  - REGISTRATION: 생성 및 참가 허용.
  - IN_PROGRESS: 시작 후, 1라운드 매치 생성 및 roomId 발급.
  - COMPLETED: 최종 경기 완료 후 설정.

## 3. API 설계
- `POST /api/tournaments`
  - 요청: { name, maxParticipants(4~16, 2의 거듭제곱) }
  - 응답: `TournamentDetailResponse` (creatorId 포함).
- `POST /api/tournaments/{id}/join`
  - 등록 상태에서만 허용, 중복 참여 차단, 정원 초과 시 400.
- `POST /api/tournaments/{id}/start`
  - 생성자만 호출 가능, 정원 충족 시 status=IN_PROGRESS, 1라운드 매치 생성 및 roomId 발급.
- `GET /api/tournaments`
  - 요약 목록 반환(creatorId, 현재 인원 수 포함).
- `GET /api/tournaments/{id}`
  - 전체 참가자, 매치 리스트 포함 상세 조회.
- 보안: 기존 JWT 필터로 보호, `/ws/tournament`는 핸드셰이크 인터셉터로 인증.

## 4. 내부 동작
- 브래킷 생성
  - 라운드 수 = log2(참가자 수), 라운드/포지션 기준으로 모든 `TournamentMatch`를 미리 생성.
  - 1라운드 매치에 시드 순서대로 A/B 배정 → `GameRoomService.createRoom`으로 roomId 발급 → 상태 READY.
- 진행 업데이트
  - `GameResultService.recordResult` 저장 후 ApplicationEventPublisher로 GameResult 이벤트 발행.
  - `TournamentProgressService` @EventListener에서 roomId로 매치 조회 → 승자 계산 → 다음 라운드 매치에 배정.
  - 다음 매치가 두 참가자를 확보하면 `TournamentService.openMatch` 호출로 roomId 발급 및 READY 전환.
  - 마지막 라운드 완료 시 `Tournament.markCompleted` 후 알림 발행.

## 5. 실시간 알림
- 퍼블리셔: `TournamentEventPublisher`
  - 사용자별 세션 맵을 유지, type/payload JSON 브로드캐스트.
- 이벤트 타입
  - `TOURNAMENT_UPDATED`/`TOURNAMENT_STARTED`/`TOURNAMENT_COMPLETED`: 전체 상세 응답 payload.
  - `TOURNAMENT_MATCH_READY`: { tournamentId, matchId, roomId, round }.

## 6. 테스트 전략
- `TournamentServiceTest`
  - 4인 토너먼트 생성→참여→시작→1라운드 결과 기록→결승 생성→결승 완료→토너먼트 COMPLETED까지 검증.
  - roomId, 상태 전이, 승자 배정 여부 확인.

## 7. 마이그레이션/주의사항
- DB: JPA auto-ddl 기준으로 신규 테이블 3개 생성(tournaments, tournament_participants, tournament_matches).
- GameRoomService는 메모리 기반이므로 토너먼트 매치 roomId도 메모리 맵에서 관리됨. 서버 재시작 시 브래킷은 유지되지만 roomId는 재생성 필요(추후 버전에서 복원 로직 고려).
