# v0.9.0 백엔드 운영/관리 설계

## 1. 목적/범위
- 운영자가 사용자 상태와 최근 전적을 조회하고 밴/정지/뮤트를 적용할 수 있는 최소 관리자 API를 제공한다.
- 백엔드 로그를 JSON으로 구조화하여 Nginx 로그와 함께 분석 가능하도록 정리한다.
- Prometheus 노출 지표를 확장해 관리자 대시보드에서 상태를 바로 확인한다.

## 2. 외부 동작
- REST API (인증 필요)
  - `GET /api/admin/users`: 사용자 목록 + 밴/정지/뮤트 상태 반환.
  - `GET /api/admin/users/{userId}/matches`: 지정 사용자의 최근 경기 20건 조회.
  - `POST /api/admin/users/{userId}/moderations`: `{ action: BAN|SUSPEND|MUTE, reason, durationMinutes }`로 제재 적용.
  - `GET /api/admin/matches`: 최근 경기 20건 조회.
  - `GET /api/admin/stats`: 사용자 수, 누적 경기 수, 활성 경기/관전자 수 반환.
- 보안/제한
  - 기존 JWT 인증 정책을 그대로 사용하며 `/api/admin/**`는 인증 필수.
  - 밴/정지 사용자는 로그인/매칭 시 403을 반환한다.
- 로깅/메트릭
  - `RequestLoggingFilter`가 모든 HTTP 요청에 대해 method/path/status/duration/userId를 JSON 로그로 남긴다.
  - `micrometer-registry-prometheus`를 통해 `/actuator/prometheus` 노출, 커스텀 게이지: `codexpong_users_total`, `codexpong_matches_total`, `codexpong_games_active`, `codexpong_spectators_active`.

## 3. 내부 구조
- 컨트롤러
  - `AdminController`: 사용자 목록/전적, 제재, 통계, 최근 경기 조회 엔드포인트 제공.
- 서비스
  - `AdminService`: 사용자 조회/제재, 전적 조회, 통계 집계. `ChatModerationService`와 `GameRoomService`, `GameResultRepository`를 조합해 상태 계산.
  - `AdminMetricsConfig`: 위 커스텀 게이지를 Prometheus 레지스트리에 등록.
- DTO
  - `AdminUserResponse`: 사용자 기본 정보 + 밴/정지/뮤트 만료 시각.
  - `ModerationRequest`: 제재 유형/사유/기간 요청 모델.
  - `AdminStatsResponse`: 통계 응답 묶음.
- 엔티티 변경
  - `User`: `banned`, `banReason`, `bannedAt`, `suspendedUntil` 필드 추가. `isSuspended()`는 KST 기준 시각을 사용.
  - `GameResultRepository`: 사용자별 최근 경기 조회 메서드 추가.
- 설정
  - `logback-spring.xml`: 콘솔 JSON 로그 인코더 사용.
  - `RequestLoggingFilter`: 구조화된 요청 로그 기록.

## 4. 데이터/호환
- JPA `ddl-auto=update`를 유지하여 신규 필드가 자동 반영되도록 함.
- 밴 플래그는 boolean 기본값 false, 정지 만료 시각은 null 허용.
- 로그 포맷이 JSON으로 바뀌었으므로 로컬에서도 `docker compose logs backend`로 확인 시 단일 라인 JSON을 가정.

## 5. 테스트
- `AdminServiceTest`: 밴/정지/뮤트 적용 시 상태 업데이트, 통계 카운트 반환 검증.
- 로그인/매칭 흐름은 기존 통합 테스트를 재사용하되, 밴/정지 사용자에 대한 403 응답을 수동 확인(추가 시나리오 필요 시 확장).

## 6. 남은 과제
- 역할 기반 접근 제어(RBAC) 추가 시 `/api/admin/**`에 관리자 역할 검증을 붙이는 것을 고려.
- 제재 해제/이력 관리 API는 추후 필요 시 확장.
