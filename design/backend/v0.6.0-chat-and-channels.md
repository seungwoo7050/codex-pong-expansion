# v0.6.0 채팅 백엔드 설계

## 1. 목적/범위
- DM, 로비, 매치 방 채팅을 저장하고 WebSocket으로 전달한다.
- 기본적인 뮤트 제재 훅을 제공해 향후 관리자 기능과 연동 가능하도록 한다.

## 2. 외부 동작
- REST API
  - `POST /api/chat/dm/{targetUserId}`: 인증 사용자 → 대상 DM 발송, 차단/뮤트 시 403.
  - `GET /api/chat/dm/{targetUserId}`: 양방향 대화 기록 조회.
  - `POST /api/chat/lobby`, `GET /api/chat/lobby`: 로비 채널 메시지 전송/히스토리 조회.
  - `POST /api/chat/match/{roomId}`, `GET /api/chat/match/{roomId}`: 경기 방 메시지 전송/조회.
- WebSocket `/ws/chat?token=...`
  - 수신 타입: `DM_SEND`, `LOBBY_SEND`, `MATCH_SEND`, `SUBSCRIBE_MATCH`.
  - 송신 페이로드: `ChatMessageResponse` JSON을 사용자 세션 또는 채널 세션으로 브로드캐스트.

## 3. 내부 구조
- 엔티티
  - `ChatMessage(id, channelType, channelKey, sender, recipient, content, createdAt)`
  - `ChatMute(id, mutedUser, reason, expiresAt)`
- 저장소
  - `ChatMessageRepository`: DM/채널별 히스토리 쿼리, 최근 메시지 조회.
  - `ChatMuteRepository`: 활성 뮤트 조회, 만료 정리.
- 서비스
  - `ChatService`: DM/로비/매치 전송, 차단/뮤트 검증, 히스토리 조회.
  - `ChatModerationService`: 뮤트 등록/조회/정리.
  - `ChatEventPublisher`: 세션/채널 맵 관리 후 WebSocket 브로드캐스트.
- 핸들러
  - `ChatWebSocketHandler`: 인증 세션 등록 → 로비 자동 구독, 명령 처리 후 대상별 전송.
- 설정
  - `WebSocketConfig`: `/ws/chat` 핸들러 등록, JWT 핸드셰이크 적용.

## 4. 데이터/호환
- `spring.jpa.hibernate.ddl-auto=update`로 신규 테이블 생성.
- DM 채널 키는 사용자 ID 정렬 후 `"a-b"` 문자열을 사용해 양방향 정규화.

## 5. 테스트
- `ChatFlowTest`: DM/로비/매치 REST 흐름 및 뮤트 제한 검증.
- WebSocket은 핵심 핸들러 단위 테스트 대신 통합 이벤트 발행 로직으로 최소 보장.
