# v0.12.0 잡 API 및 상태 머신 설계

## 1. 목적
- 리플레이 MP4/썸네일 내보내기 요청을 백엔드가 **비동기 잡**으로 관리하고 진행률/결과를 노출한다.
- Redis Streams 큐와 워커를 통해 CPU/IO 부하를 분리하며, 동일 jobId에 대한 **멱등성**을 보장한다.
- REST + WebSocket 조합으로 생성→모니터링→다운로드 흐름을 완성한다.

## 2. 범위
- `job` 테이블/엔티티 추가 및 상태/결과 필드 정의.
- API:
  - `POST /api/replays/{replayId}/exports/mp4`
  - `POST /api/replays/{replayId}/exports/thumbnail`
  - `GET /api/jobs/{jobId}`
  - `GET /api/jobs`
  - `GET /api/jobs/{jobId}/result`
- Redis Streams를 사용한 요청/진행률/결과 메시지 발행 및 소비.
- 워커 피드백을 DB와 WebSocket에 반영하는 상태 머신.
- 최소한의 재시도/데드레터 정책 명시.

## 3. 외부 동작
### 3.1 REST 계약
- `POST /api/replays/{replayId}/exports/mp4`
  - 본인 소유 리플레이만 허용, 바로 `jobId` 반환.
  - 응답: `{ jobId }`.
- `POST /api/replays/{replayId}/exports/thumbnail`
  - 동일 권한/검증, 응답 형식 동일.
- `GET /api/jobs/{jobId}`
  - 소유자 전용. `status`, `progress`, `resultUri`, `errorCode/errorMessage`, `createdAt/startedAt/endedAt` 포함.
- `GET /api/jobs`
  - 소유자 전용 페이지 조회. `jobType`, `status` 필터와 `page/size` 지원.
- `GET /api/jobs/{jobId}/result`
  - 완료된 잡만 허용. 저장된 `resultUri` 경로 파일을 다운로드 스트림으로 반환.
  - `jobs.export.path` 하위 경로만 응답하며, 루트 밖 경로는 400으로 거부한다.

### 3.2 상태 전이 및 멱등성
- 상태 흐름: `QUEUED` → `RUNNING` → (`SUCCEEDED` | `FAILED` | `CANCELLED`).
- 동일 `jobId` 기준으로:
  - 요청 스트림에 **1회만** 발행한다(서비스 레이어에서 중복 생성 방지).
  - 진행률/결과 이벤트는 백엔드가 터미널 상태 이후 무시하여 중복 결과 생성 방지.
  - 워커는 전달된 `outputPath`를 기준으로 덮어쓰지 않고 성공 시 체크섬과 함께 1회 기록한다.

### 3.3 오류/재시도/데드레터
- Redis Streams 소비 중 파싱/처리 실패 시 `job.deadletter` 스트림으로 이동 후 ACK한다.
- 자동 재시도는 최소화하고, 필요 시 운영자가 deadletter를 분석해 재발행한다(재발행 시 동일 `jobId`를 유지해 멱등성을 보장).
- 워커 재시도는 워커 내부 정책에 위임하되, 동일 메시지를 중복 소비해도 백엔드는 터미널 상태 이후 무시한다.

## 4. 내부 구조
### 4.1 DB/엔티티
- `jobs` 테이블 컬럼:
  - `job_id`(PK, auto increment), `job_type`(ENUM), `owner_user_id`(FK), `target_replay_id`(FK),
    `status`(ENUM), `progress`(INT), `created_at`, `started_at`, `ended_at`,
    `error_code`, `error_message`, `result_uri`, `result_checksum`.
- `Job` 엔티티: `@PrePersist`로 `createdAt`을 `Asia/Seoul` 기준으로 세팅, 상태/타임스탬프 전이 메서드 포함.

### 4.2 서비스 계층
- `JobService`
  - 리플레이 소유자 검증 후 `Job` 생성, `outputPath` 옵션을 계산해 큐로 발행.
  - 진행률(`JobProgressMessage`) 수신 시 `RUNNING` + `progress` 업데이트, WebSocket `job.progress` 전파.
  - 결과(`JobResultMessage`) 수신 시 `SUCCEEDED/FAILED/CANCELLED` 전이, 파일 경로/오류 코드 저장, WebSocket `job.completed`/`job.failed` 전파. 결과 경로가 `jobs.export.path` 밖이면 `INVALID_OUTPUT_PATH`로 실패 처리한다.
  - 결과 다운로드 시 소유자/상태/파일 존재 여부 검증.
- `JobQueuePublisher`
  - Redis Streams `job.requests`에 `jobId/jobType/replayId/options` 맵을 단순 적재(멱등성은 서비스/워커에서 보장).
- `JobQueueListener`
  - `job.progress`/`job.results` 스트림을 소비.
  - 컨슈머 그룹이 없으면 부트스트랩 엔트리를 추가해 생성.
  - 처리 실패 레코드는 `job.deadletter`로 이동 후 ACK하여 무한 재시도 방지.
- `JobEventPublisher`
  - `Sinks.Many`를 통해 사용자별 WebSocket 세션에 이벤트 브로드캐스트.

### 4.3 메시지 포맷 (고정)
- 요청: `{ jobId, jobType, replayId, options{inputPath, outputPath, durationMs, ownerId, createdAt} }`.
- 진행률: `{ jobId, progress, phase, message }`.
- 결과: `{ jobId, status, resultUri, checksum, errorCode, errorMessage }`.

## 5. 테스트 전략
- `JobFlowTest`(Testcontainers Redis):
  - 리플레이 생성 → MP4 잡 생성 → 테스트 워커 대신 Redis에 progress/result 직접 발행 → WebSocket 진행률/완료 이벤트 및 결과 다운로드 가능 여부 검증.
- 기존 리플레이/매치 테스트 회귀 실행으로 v0.11 기능이 깨지지 않는지 확인.

## 6. 마이그레이션/호환성
- `spring.jpa.hibernate.ddl-auto=update`로 로컬/CI에서 `jobs` 테이블이 자동 생성된다. 운영 환경에서는 명시적 마이그레이션 스크립트를 권장.
- Redis Streams가 비어 있어도 컨슈머 그룹을 생성해 첫 메시지에서 예외가 발생하지 않도록 부트스트랩 엔트리를 추가한다.
- 향후 워커 교체(다른 언어/배포) 시에도 메시지 포맷과 상태 머신을 고정하여 호환성을 유지한다.
