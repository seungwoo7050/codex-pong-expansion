# v2.0 gRPC Contracts

Canonical proto definitions for the initial service extraction. Contracts are
stored under `contracts/services/**` and are the source of truth.

## Common rules
- Proto package per service: `codexpong.<svc>.v2`.
- TraceContext is required on every request for trace/correlation propagation.
- Error mapping: gRPC status codes are translated by edge-api into the existing
  REST error envelope; no new external error shapes are introduced in v2.0.
- Timeouts/retries are explicit per client with telemetry for failures.

## IdentityService (`contracts/services/identity/v2.proto`)
- `ValidateToken`: validates an access token locally and optionally returns
  claims for downstream personalization. No remote DB lookups by callers; they
  rely on the response only.
- `GetProfile`: minimal profile fetch for user-facing displays behind edge-api.
- `GetKeySet`: exposes verification keys (JWKS-like) so edge-api and
  realtime-gateway can cache keys and validate tokens without per-request
  calls.

## MatchService (`contracts/services/match/v2.proto`)
- `PersistMatchResult`: authoritative write for match results. Called only by
  shard with traceId and shard metadata. Transactionally writes result + outbox.
- `QueryMatchHistory`: paged history for a given user. Edge-api maps REST calls
  to this RPC; service enforces ownership of `match_*` tables.

## ChatService (`contracts/services/chat/v2.proto`)
- `SendMessage`: posts a chat message into `chat_*` tables with trace context for
  moderation/audit trails.
- `ListMessages`: paged retrieval per channel with cursor-based pagination to
  avoid cross-service joins.

## Validation
- `scripts/contract-test.sh` compiles all protos and optionally validates
  external OpenAPI specs when present.
- Contracts must be regenerated/updated before code changes that affect IO or
  semantics; the proto files are committed artifacts.
