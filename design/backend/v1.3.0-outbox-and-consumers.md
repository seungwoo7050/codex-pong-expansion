# v1.3.0 아웃박스 & 소비자 설계

## 목표
- 매치 종료 이벤트를 아웃박스 테이블에 동기 트랜잭션으로 기록한다.
- 릴레이가 재시도/멱등성/DLQ를 관리하며, 랭킹/통계/알림/이상징후 소비자가 비동기 처리한다.

## 아키텍처
- **Outbox**: `outbox_events` (eventId, type, payload, status, attempts, lastError, created/updatedAt)
  - 도메인 트랜잭션과 함께 저장, `status=PENDING` 초기화.
- **Relay**: `OutboxRelayService`
  - `@Scheduled` 주기적으로 PENDING 배치를 조회(`batch-size` 기본 20).
  - 소비자 처리 트랜잭션 실패 시 롤백 후 `attempts` 증가, `max-attempts`(기본 3) 초과 시 DLQ 적재.
- **DLQ**: `dead_letter_events` (eventId, type, payload, failedAttempts, lastError, failedAt)
  - 운영자가 재처리 또는 폐기 결정 시 참고.
- **멱등성**: `event_consumptions`에 `(eventId, consumerName)` 기록. 존재하면 소비 로직 스킵.
- **소비자별 프로젝션**
  - `ranking_projections`: 사용자별 최신 레이팅 스냅샷.
  - `player_match_stats`: 승/패/무 및 총 경기 수.
  - `notification_logs`: eventId+userId 유니크 제약으로 중복 알림 방지.
  - `abuse_signals`: 점수 편차/비정상 레이팅 변동 감지 기록.

## 이벤트 페이로드
- 타입: `MATCH_RESULT_RECORDED`
- 스키마: `MatchResultEventPayload`
  - eventId, gameResultId, roomId, playerAId/BId, scoreA/B, matchType, ratingChangeA/B, ratingAfterA/B, startedAt, finishedAt
- 생성: `GameResultService.recordResult`에서 `OutboxEventWriter`를 통해 eventId 포함 직렬화.

## 소비자 동작
- **RankingEventConsumer**
  - 최신 레이팅을 프로젝션 테이블에 upsert.
- **StatsEventConsumer**
  - 점수 비교 후 승/패/무 카운터 및 totalMatches 증가.
- **NotificationEventConsumer**
  - 두 사용자에게 요약 메시지 로그 작성(멱등성 검사 포함).
- **AbuseSignalConsumer**
  - 점수 차 10점 이상, 또는 ±50 이상 레이팅 변동 시 해당 사용자 신호 적재.

## 재시도 & DLQ 정책
- 실패 시 시도 횟수 +1, `status=PENDING` 유지.
- `max-attempts` 초과 시 `status=FAILED` + DLQ 적재.
- 운영 재처리: DLQ 문서(runbooks/v1.3.0-dlq-ops.md) 참조.

## 테스트 게이트 매핑
- 트랜잭션 결합: 롤백 시 outbox/game_result 모두 저장되지 않음을 검증.
- 멱등성: 상태를 PENDING으로 재주입해도 소비자 프로젝션이 변하지 않음.
- 재시도→DLQ: 지정된 roomId 실패 소비자로 attempts 누적 후 DLQ 적재 확인.

## 설정 값
- `outbox.relay.batch-size` (기본 20)
- `outbox.relay.max-attempts` (기본 3)
- `outbox.relay.interval-millis` (기본 1000ms)
