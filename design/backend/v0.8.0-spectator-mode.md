# v0.8.0 백엔드 설계 – 관전 모드/라이브 보기

## 1. 개요
- 목표: 진행 중인 게임 방에 인증 사용자가 관전자로 입장해 지연된 스냅샷을 수신하도록 한다.
- 범위: GameRoomService/WebSocket 핸들러 확장, 관전 목록 REST API 추가, 관전자 수 제한/브로드캐스트 지연 정책 적용.
- 배경: v0.7.0까지 플레이어 중심의 실시간 이벤트만 지원했으므로, 관전자 역할을 분리해 부하를 제어하고 입장/종료 흐름을 추적한다.

## 2. 아키텍처 및 주요 결정
- 관전자 연결 정책
  - 방별 최대 관전자 수: 30명(`MAX_SPECTATORS_PER_ROOM`).
  - 관전자에게는 250ms 지연 전송을 적용해 플레이어와의 자원 경쟁을 완화한다.
  - 인증된 사용자만 관전 가능하며, 종료된 방(room 제거)에는 입장할 수 없다.
- 역할 구분
  - WebSocket 쿼리 파라미터 `role=spectator` → 관전자 세션으로 등록.
  - 기본은 `PLAYER`이며, 플레이어가 아닌 사용자가 `PLAYER`로 접속 시 거부한다.
- 메시지 포맷 확장
  - `GameServerMessage` 필드: `audienceRole`, `spectatorCount` 추가.
  - 플레이어/관전자 모두 동일한 스냅샷 구조를 받되, 역할에 따라 입력 허용 여부를 클라이언트가 구분한다.

## 3. API 설계
- REST
  - `GET /api/match/ongoing`
    - 인증 필요.
    - 응답: `[ { roomId, matchType, leftPlayerId, leftNickname, rightPlayerId, rightNickname, startedAt, spectatorCount, spectatorLimit } ]`
    - 용도: 관전 목록/버튼 렌더링.
- WebSocket
  - 엔드포인트: `/ws/game?roomId=<id>&token=<JWT>&role=spectator|player`
  - 거부 조건: roomId 누락, 인증 실패, 종료된 방, 관전자 초과.
  - READY 메시지: `type=READY`, 현재 스냅샷 + `audienceRole`, `spectatorCount` 포함.

## 4. 내부 동작
- GameRoomService
  - 맵 분리: `roomSessions`(플레이어) + `spectatorSessions`(관전자) 관리.
  - `registerSpectatorSession`에서 한도 검사 후 등록, `unregisterSession`으로 세션 종료 시 정리.
  - `broadcastState`는 플레이어 즉시 전송, 관전자는 250ms 지연 후 동일 스냅샷 전송.
  - `listLiveRooms`로 진행 중 방 목록 제공 → REST 응답 변환.
- GameWebSocketHandler
  - `role` 파라미터 파싱 → 관전자면 입력 무시, 플레이어면 기존 입력 처리 유지.
  - 세션 속성에 `audienceRole` 저장 후 READY 메시지 전달.

## 5. 정책 및 예외
- 관전자 초과 시 `POLICY_VIOLATION` 코드와 한국어 사유로 연결 종료.
- 종료된 방은 관전 불가(방 제거 후 목록/웹소켓 모두 거부).
- 현재 구현은 단일 인스턴스 메모리 맵에 의존하므로 서버 재시작 시 진행 중인 방/관전 세션은 사라진다.

## 6. 테스트 전략
- `SpectatorControllerTest`: 진행 중 방을 만든 뒤 `/api/match/ongoing` 응답에 roomId/관전자 제한 정보가 포함되는지 검증.
- `GameRoomServiceSpectatorTest`: 관전자 등록이 30명까지만 성공하고 초과 시 false 반환되는지 확인.
- WebSocket 핸들러는 통합 테스트 대신 지연 정책/역할 구분을 프런트 훅과 함께 수동 검증하도록 문서화.
