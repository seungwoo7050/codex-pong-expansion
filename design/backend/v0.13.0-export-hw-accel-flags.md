# v0.13.0 리플레이 내보내기 HW 가속 플래그 설계

## 1. 목적
- 워커가 FFmpeg 하드웨어 인코더를 우선 사용하되, 미지원 환경에서도 안전하게 CPU(libx264)로 폴백한다.
- 환경 변수 하나(`EXPORT_HW_ACCEL`)로 GPU 사용 여부를 제어하고, 실행 시 지원 가능성을 로깅해 운영자가 즉시 파악할 수 있게 한다.
- 실패 시 명확한 오류 코드/메시지를 반환해 잡 상태에서 원인을 확인할 수 있도록 한다.

## 2. 범위
- 워커 프로세스 시작 시 FFmpeg 지원 목록(hardware accel/encoders/decoders) 수집 및 로그 출력.
- `EXPORT_HW_ACCEL=true`일 때 HW 인코더 선택 → 실패 시 자동 소프트웨어 재시도.
- MP4 인코딩 경로만 HW 대상이며, 썸네일/다른 잡 유형은 기존 로직 유지.
- 오류 코드 확장: `FFMPEG_FAILED_HW`, `WORKER_HW_FALLBACK_FAILED` 등.

## 3. 외부 동작
- 환경 변수
  - `EXPORT_HW_ACCEL=true|false` (기본 false): true면 감지된 HW 인코더를 우선 시도.
- 로그
  - 시작 시: `하드웨어 인코딩 감지: encoder=h264_nvenc, hwaccel=cuda` 또는 폴백 안내.
  - 실패 시: `하드웨어 인코딩 실패, CPU 경로로 폴백` 경고를 남긴 뒤 libx264 경로 실행.
- 잡 결과
  - 성공 시 기존과 동일하게 `SUCCEEDED` + checksum 제공.
  - 실패 시 오류 코드:
    - `INVALID_OUTPUT_PATH`, `INVALID_REPLAY_FORMAT` 기존 유지.
    - HW 시도 실패 후 폴백 실패 → `FFMPEG_FAILED_HW` 또는 `WORKER_HW_FALLBACK_FAILED`.

## 4. 내부 구성
### 4.1 하드웨어 감지
- `detect_ffmpeg_capabilities()`
  - `ffmpeg -encoders`, `-hwaccels`, `-decoders` 출력에서 NVENC/QSV/VAAPI/VideoToolbox/AMF 관련 인코더를 수집.
  - 예외 발생 시 워닝 로그만 남기고 진행(FFmpeg 미설치 환경 대비).
- `select_hw_encoder()`
  - 우선순위: `h264_nvenc` → `h264_qsv` → `h264_vaapi` → `h264_videotoolbox` → `h264_amf`.

### 4.2 인코딩 실행 흐름
- `export_mp4()`
  - `EXPORT_HW_ACCEL`이 true이고 지원 인코더가 있으면 1차로 HW 경로 시도.
  - VAAPI일 경우 `format=nv12,hwupload` 필터를 추가하고, NVENC는 `-hwaccel cuda`, QSV는 `-hwaccel qsv`를 사용.
  - 실패 시 tmp 파일을 제거하고 libx264 경로를 다시 실행.
  - 호출부에서 `ffmpeg_runner`를 주입 가능하게 만들어 테스트 시 모킹 용이.
- `run_ffmpeg()`
  - 기존 rawvideo → MP4 파이프라인 유지, 인코더/필터/`-hwaccel` 옵션만 변경 가능하도록 확장.

## 5. 테스트 전략
- `test_export_mp4_generates_video`: SW 경로 기본 성공을 계속 검증.
- `test_hw_encode_flag_falls_back_to_software`: `EXPORT_HW_ACCEL=true` + HW 인코더 지정 후 1차 실패를 모킹하여 libx264 폴백 성공을 확인.
- CI는 CPU-only로 실행하며, 로컬 GPU 환경에서는 ffmpeg 실제 NVENC/VAAPI 성공 여부를 수동 확인(문서화)한다.

## 6. 호환/확장
- HEVC 등 추가 코덱이 필요하면 우선순위 목록에 해당 인코더를 추가한다.
- 운영 환경별 장치 경로(예: VAAPI `/dev/dri/renderD128`)는 `.env`나 Docker 러ntime 설정에서 주입하도록 후속 버전에서 확장 가능하다.
- HW 실패 시에도 결과물이 깨끗이 정리되도록 tmp 파일 삭제 절차를 유지한다.
