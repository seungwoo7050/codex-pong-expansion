# v0.11.0 리플레이 저장소 및 보존 정책 설계

## 1. 목적
- 리플레이 이벤트 파일을 안전하게 보관하고 용량 폭주를 막기 위한 최소 보존 정책을 정의한다.
- 로컬 개발/배포 환경에서 동일한 경로와 볼륨 구성을 사용해 재생 파일 접근을 단순화한다.

## 2. 범위
- Docker Compose 서비스/볼륨 정의 변경 (`replay_data` named volume).
- Backend 컨테이너 마운트 경로 `/data/replays` 및 관련 환경변수.
- 사용자당 리플레이 보존 개수 제한(기본 20개) 적용 로직.

## 3. 구성
### 3.1 Docker Compose
- `backend` 서비스에 볼륨 마운트 추가: `replay_data:/data/replays`.
- 환경변수:
  - `REPLAY_STORAGE_PATH=/data/replays`
  - `REPLAY_RETENTION_MAX_PER_USER=20`
- `volumes` 섹션에 `replay_data` named volume 정의. DB(`db_data`)와 분리해 스냅샷 파일만 별도 관리.

### 3.2 애플리케이션 설정
- `application.properties` 기본값:
  - `replay.storage.path=${user.dir}/build/replays` (로컬/CI 테스트 시 프로젝트 내부 경로로 기록, 권한 이슈 회피)
  - `replay.retention.max-per-user=20`
- Docker Compose 실행 시 환경변수로 `/data/replays`를 주입해 named volume을 사용한다.
- `ReplayService`에서 경로를 생성하고 JSONL 파일을 기록하며, 파일 체크섬(SHA-256) 계산 후 DB에 저장.

### 3.3 보존 정책
- 사용자당 최신 20개만 유지. 새 리플레이 저장 후 `findByOwnerOrderByCreatedAtDesc` 결과를 기준으로 초과분을 삭제.
- 파일 정리: 동일 스토리지 URI 참조 수가 0이 된 경우에만 `Files.deleteIfExists`로 제거(두 플레이어가 공유하는 파일을 보호).

## 4. 운영/모니터링 고려사항
- 모니터링 스택(Prometheus/Grafana)은 기존 설정 유지. 리플레이 볼륨 사용량을 추적하려면 추가 대시보드는 후속 버전에서 정의.
- 로그는 기존 JSON 포맷 유지. 리플레이 파일 이름은 `roomId-matchId.jsonl` 규칙을 사용해 문제 발생 시 역추적 가능.

## 5. 테스트/검증
- `ReplayControllerTest`에서 녹화→저장→스트리밍까지 통합 흐름을 검증해 볼륨/경로 설정이 유효한지 확인.
- Docker Compose 로컬 실행 시 `/data/replays`에 JSONL 파일이 생성되는지 수동 확인(필요 시 `docker compose exec backend ls /data/replays`).
