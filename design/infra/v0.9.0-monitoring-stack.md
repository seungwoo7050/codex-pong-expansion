# v0.9.0 모니터링 스택 설계

## 1. 목적/범위
- 로컬/개발 환경에서 서비스 상태를 빠르게 확인하기 위해 Prometheus + Grafana 스택을 추가한다.
- Nginx/백엔드 로그를 JSON으로 정리해 이후 로그 수집기(ELK 등) 연동을 용이하게 한다.

## 2. 구성 요소
- Prometheus
  - 설정 파일: `infra/monitoring/prometheus.yml`
  - 스크레이프 대상: `backend:8080/actuator/prometheus`
  - 스크레이프 주기: 15s
- Grafana
  - 데이터 소스 프로비저닝: `infra/monitoring/grafana/datasources/prometheus.yml`
  - 대시보드 프로비저닝: `infra/monitoring/grafana/dashboards/dashboards.yml`
  - 기본 대시보드: `admin-overview.json` (UID `codexpong-admin-overview`)
  - 기본 계정: `admin/admin` (로컬 개발용)
- 로그
  - Nginx: `log_format structured`로 JSON 접근 로그(`request_time`, `upstream_response_time`) 출력.
  - 백엔드: `logback-spring.xml`에서 `LogstashEncoder`를 사용해 method/path/status/userId/durationMs 필드를 남김.

## 3. Docker Compose
- 신규 서비스
  - `prometheus`: 9090 포트 노출, backend 의존.
  - `grafana`: 3000 포트 노출, prometheus 의존, 프로비저닝/대시보드 디렉터리 마운트.
- 기존 nginx는 prometheus 기동 후에도 정상 라우팅되도록 `depends_on`에 prometheus 추가.

## 4. 대시보드 지표
- HTTP 요청수: `http_server_requests_seconds_count` 5분 구간 합계(method 기준).
- 에러 비율: 5xx 카운트 / 전체 요청 (5분 구간).
- 지연: `histogram_quantile(0.9, http_server_requests_seconds_bucket)`를 ms 단위로 변환.
- 활성 경기/관전자: `codexpong_games_active`, `codexpong_spectators_active` 커스텀 게이지.

## 5. 운영/확장 메모
- 운영자 계정이 없으므로 JWT 토큰을 수동 발급 받은 사용자만 `/admin` UI 접근 가능(추후 RBAC 고려).
- 실서비스 적용 시 Grafana 기본 계정 변경 및 대시보드 접근 제어 필요.
- 로그 수집기는 현재 표준 출력 기준으로 docker logs로 확인, 추후 Loki/ELK 연동 시 JSON 포맷 그대로 사용.
