# v1.1.0 실시간 인프라 토폴로지

## 목표
- 게이트웨이/샤드 분리를 Docker Compose 기준으로 명확히 정의하고 Redis 단일 인스턴스를 공유한다.

## 구성요소
- `api-service`: 기존 REST/매치메이킹 API.
- `realtime-gateway`: Stateless WebSocket 엔드포인트, Redis만 의존.
- `game-session-shard`: 다중 인스턴스 가능, Redis Streams/heartbeat 사용.
- `redis`: 단일 인스턴스(향후 Cluster 대응), persistence 옵션 활성.

## 네트워크
- Nginx 라우팅: `/api/*` → api-service, `/ws/*` → realtime-gateway.
- shard는 내부 네트워크에서만 Redis 접근.

## 구성 파라미터
- `GATEWAY_RECONNECT_WINDOW_SECONDS`(기본 10)
- `SHARD_HEARTBEAT_INTERVAL_SECONDS`(기본 2)
- `SHARD_HEARTBEAT_TTL_SECONDS`(기본 5)
- `STREAM_REQUEST_PREFIX=game:request:`
- `STREAM_RESPONSE_PREFIX=game:response:`

## 상태 저장소
- `shard:registry` hash + `shard:heartbeat:{id}` key
- `session:owner` hash (session→shard)
- `termination:{sessionId}` hash (reason/detail/timestamp)

## 운영 메모
- 단일 노드 배포라도 Redis를 경유하도록 구성해 스케일아웃 시 코드 변경을 피한다.
- 샤드 롤링 시 heartbeat TTL이 끊기면 게이트웨이가 SHARD_UNAVAILABLE로 종료하도록 설계되었으므로 무중단을 위해 shard 교대 배치 필요.
