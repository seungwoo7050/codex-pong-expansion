# v1.0.0 실시간 오버뷰

## 1. 목적
- 게임/채팅/토너먼트/잡 진행 알림 등 WebSocket 경로를 v1.0.0 기준으로 통합 요약한다.
- 재연결 정책과 이벤트 계약을 정리해 수동 점검 시 누락을 방지한다.

## 2. 공통 엔드포인트/인증
- 전송 방식: raw WebSocket.
- 공통 쿼리: `token=<JWT>` 필수, 게임/관전은 `roomId`, 관전자는 `role=spectator` 추가.
- 연결 실패 시 즉시 4401 코드로 종료, 3회 백오프 후 사용자가 새 토큰으로 재시도하도록 안내.

## 3. 채널별 계약
- 게임(`/ws/game`)
  - 클라 → 서버: `INPUT { direction: UP|DOWN|STAY }`.
  - 서버 → 클라: `READY`, `STATE`(50ms 틱), `FINISH`(최종 스코어), 관전자에게도 동일 스냅샷 브로드캐스트.
- 소셜(`/ws/social`)
  - 친구 요청/수락/차단 이벤트, 초대 알림을 push. payload는 userId, nickname, room/tournament id 포함.
- 채팅(`/ws/chat`)
  - 텍스트 메시지 전송, 서버는 금칙어/밴/뮤트 검증 후 `CHAT_MESSAGE` 이벤트로 브로드캐스트.
- 토너먼트(`/ws/tournament`)
  - 브래킷 업데이트, 매치 ready/started/finished 이벤트를 참가자에게 전송.
- 잡(`/ws/jobs`)
  - replay export/썸네일 생성 진행률을 `JOB_PROGRESS`/`JOB_COMPLETED`/`JOB_FAILED`로 전달.
- 에코(`/ws/echo`)
  - 헬스 체크용. payload 원형 유지로 UTF-8 회귀 테스트에 사용.

## 4. 상태 관리/오류 처리
- 서버는 room/tournament/채팅 참가자 목록을 Redis에 캐싱하고, 세션 종료 시 정리한다.
- 연결 중단 시 마지막 성공 스냅샷을 클라이언트 캐시에 유지해 재접속 시 화면 플리커를 줄인다.
- 이벤트 순서는 `seq` 필드로 보장하며, 누락 감지 시 클라이언트는 `/api/...` 보조 REST 조회로 복구한다.

## 5. 테스트/운영 메모
- `IntegrationSmokeTest`에서 `/ws/echo` 핸드셰이크와 기본 송수신 검증.
- `JobFlowTest`에서 Redis Streams → WebSocket fan-out 경로 검증.
- Nginx `proxy_read_timeout` 120s, 백엔드 `WebSocketConfigurer`에서 origin 제한 및 메시지 크기 제한 적용.

## 6. 남은 제한사항
- 글로벌 매치 브로커/멀티 리전 세션 스티키니스는 구성되어 있지 않아 단일 인스턴스 가정이다.
- WebSocket 메시지는 JSON 텍스트 전송만 지원하며, 이진 프레임/압축 설정은 비활성화 상태다.
- 게임/토너먼트 이벤트는 재전송 큐 없이 best-effort 브로드캐스트로, 장시간 네트워크 단절 시 수동 새로고침이 필요하다.
