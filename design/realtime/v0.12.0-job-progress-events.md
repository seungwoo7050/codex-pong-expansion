# v0.12.0 잡 진행률 실시간 이벤트 설계

## 1. 목적
- 리플레이 내보내기 잡의 진행률/결과를 **WebSocket**으로 푸시하여 사용자가 페이지를 새로고침하지 않고 상태를 확인하도록 한다.
- 워커 → 백엔드 → 프런트엔드까지 이벤트 경로와 payload 스키마를 고정해 후속 버전에서도 호환성을 유지한다.

## 2. 범위
- WebSocket 엔드포인트 `/ws/jobs` 계약 정의.
- 이벤트 타입과 payload:
  - `job.progress`
  - `job.completed`
  - `job.failed`
- Redis Streams 수신 → WebSocket 브로드캐스트 흐름.
- 재연결/세션 관리 기본 정책.

## 3. 외부 동작
### 3.1 엔드포인트
- 경로: `/ws/jobs`
- 프로토콜: raw WebSocket, 쿼리 파라미터 `token=<JWT>`로 인증.
- 구독 모델: 접속한 사용자의 job 이벤트만 전달(서버가 ownerId로 필터링). 별도 subscribe 메시지 없이 전 이벤트를 수신한다.

### 3.2 이벤트 포맷
- 공통 필드: `type`, `jobId`.
- `job.progress`
  - Payload: `{ type: "job.progress", jobId, progress, phase, message }`
  - `progress`: 0..100, `phase`: 워커 단계(예: PREPARE/ENCODE/FINALIZE), `message`: 사람이 읽을 수 있는 로그.
- `job.completed`
  - Payload: `{ type: "job.completed", jobId, downloadUrl, checksum }`
- `job.failed`
  - Payload: `{ type: "job.failed", jobId, errorCode, errorMessage }`
  - 절대경로 노출 방지를 위해 `resultUri`는 포함하지 않고, API 다운로드 경로(`/api/jobs/{jobId}/result`)만 전달한다.

### 3.3 재연결/보장
- 세션이 끊겼을 때 프런트엔드는 `useJobSocket` 훅에서 자동 재시도를 수행하지 않고, 사용자가 페이지를 다시 열 때 새 세션을 만든다.
- 진행률 이벤트는 **최소 0..100 단조 증가**를 가정하지 않는다. 백엔드는 단순 덮어쓰기 모델이며, 터미널 이벤트(`completed/failed`) 이후 들어오는 이벤트는 무시된다.
- 메시지는 Redis Streams → WebSocket 단일 전달이며, 동일 메시지 중복 시 클라이언트는 `jobId` 기준으로 마지막 값을 사용한다.

## 4. 내부 구조
### 4.1 백엔드 이벤트 파이프라인
- `JobQueueListener`가 `job.progress`/`job.results`를 소비 → `JobService`로 전달.
- `JobService`가 상태 전이 및 DB 저장 후 `JobEventPublisher`에 위임.
- `JobWebSocketHandler`가 사용자별 세션 맵을 유지하며 `JobEventPublisher`의 `Sinks.Many`를 구독해 이벤트를 브로드캐스트.
- 모든 JSON 직렬화는 Jackson을 사용, 서버 타임존 `Asia/Seoul` 유지.

### 4.2 클라이언트 처리 흐름
- `useJobSocket` 훅이 `/ws/jobs?token=...` 연결을 시도하고, 이벤트 핸들러를 등록한다.
- `job.progress` 수신 시 JobDrawer의 진행률/로그 상태를 업데이트, `job.completed`에서 다운로드 링크를 표시, `job.failed`에서 오류를 노출한다.
- 연결 실패 시 훅이 즉시 에러를 반환하며, 페이지에서 폴백으로 `GET /api/jobs/{jobId}`를 통해 상태를 조회할 수 있다.

## 5. 테스트 전략
- `JobFlowTest`에서 테스트용 WebSocket 클라이언트를 열고 Redis로 progress/result를 주입해 `job.progress`/`job.completed` 이벤트 수신 여부를 검증한다.
- 프런트엔드 `JobsPage.test.tsx`와 `ReplayViewerPage` 테스트에서 소켓 핸들러 가드를 통해 WebSocket 미지원 환경에서도 렌더링이 유지되는지 확인한다.

## 6. 호환성 및 확장
- 이벤트 타입 문자열(`job.progress`, `job.completed`, `job.failed`)을 고정해 이후 버전에서도 동일한 키를 사용한다.
- 향후 잡 취소/재시도 이벤트가 추가되더라도 기존 타입을 변경하지 않고 확장 이벤트로 추가한다.
- 메시지 내 `phase`는 문자열 자유도(예: `FFMPEG_PREPARE`, `FFMPEG_ENCODE`, `UPLOAD`)를 허용하며, 클라이언트는 미지의 phase를 단순 텍스트로 표시한다.
