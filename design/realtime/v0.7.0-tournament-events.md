# v0.7.0 실시간 설계 – 토너먼트 이벤트

## 1. 개요
- 목적: 토너먼트 브래킷 진행에 필요한 WebSocket 알림을 정의한다.
- 엔드포인트: `/ws/tournament?token=<JWT>` (WebSocketConfig에 등록, JWT 핸드셰이크 사용).
- 소비자: 프론트엔드 `useTournamentSocket` 훅.

## 2. 연결/세션 관리
- 토큰 기반 인증 실패 시 406으로 즉시 종료.
- `TournamentEventPublisher`가 사용자별 세션 세트를 관리하며, 동일 사용자의 다중 접속을 허용한다.
- ping/pong 텍스트 메시지로 간단한 연결 상태 확인.

## 3. 이벤트 타입 및 페이로드
- `TOURNAMENT_UPDATED`
  - payload: TournamentDetailResponse 전체 (id, name, creatorId, status, participants, matches)
  - 발생 시점: 참가자 추가, 매치 완료 후 브래킷 갱신 등.
- `TOURNAMENT_STARTED`
  - payload: TournamentDetailResponse
  - 발생 시점: 시작 API 호출 후 1라운드 매치 생성/roomId 발급 직후.
- `TOURNAMENT_COMPLETED`
  - payload: TournamentDetailResponse
  - 발생 시점: 결승전 종료 후 상태 COMPLETED 전환 시.
- `TOURNAMENT_MATCH_READY`
  - payload: { tournamentId, matchId, roomId, round }
  - 발생 시점: 매치에 두 참가자가 배정되고 GameRoomService로 roomId 발급이 완료된 직후.

## 4. 서버 발행 흐름
- 참가/시작/완료 등 REST 처리 중 `TournamentService.publishUpdatedDetail`로 상세 응답을 브로드캐스트.
- 매치 결과 저장 → GameResultService가 GameResult 이벤트 발행 → TournamentProgressService가 수신해 승자 배정/다음 라운드 READY 처리 → 알림 발행.
- 발행 실패는 무시하되, payload는 JSON 직렬화 가능 객체만 사용한다.

## 5. 클라이언트 처리 지침
- `useTournamentSocket`에서 수신한 메시지 타입에 따라:
  - UPDATED/STARTED/COMPLETED: 상태 트리에 상세 응답을 반영하고 목록 재조회.
  - MATCH_READY: payload.tournamentId가 현재 상세와 일치하면 상세 재조회 또는 roomId 안내.
- 연결 상태를 표시해 사용자에게 알림 수신 준비 여부를 안내한다.

## 6. 보안/제한사항
- JWT가 필요한 보호 채널이며, 세션당 발행량은 소규모 브래킷 기준으로 메모리 퍼블리셔로 처리한다.
- 서버 재시작 시 기존 roomId는 소멸하므로 READY 이벤트가 다시 발생할 수 있음을 주석/가이드에 명시.
