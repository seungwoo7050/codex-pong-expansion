# v1.1.0 실시간 프로토콜 개요

## 목표
- WebSocket 클라이언트-게이트웨이 경로와 게이트웨이-샤드 Streams 경로를 단일 스펙으로 정리한다.

## 클라이언트 메시지
- `CLIENT_INPUT` : `{direction}`
- `RECONNECT` : 빈 payload, 게이트웨이가 `SESSION_RECONNECTED`를 샤드로 위임

## 게이트웨이 메시지
- 요청 스트림 `game:request:{shardId}`
  - `SESSION_CONNECTED` : `{token}`
  - `SESSION_RECONNECTED` : `{}`
  - `FORWARD_INPUT` : `{direction}`
- 응답 스트림 `game:response:{sessionId}`
  - `SESSION_ACK`, `PLAY_STARTED`, `STATE_SNAPSHOT`, `TERMINATED`

## 순서 및 idempotency
- Streams는 at-least-once 소비, `messageId`로 중복 제거.
- 세션 내 순서는 Stream ID 기반으로 보장한다.

## 재접속 윈도우
- `gateway.reconnect.windowSeconds` 기본 10초.
- 윈도우 내 shard heartbeat가 유효하면 재접속 성공, 아니면 종료 컨텍스트 사용.

## 종료 사유
- AUTH_FAILURE / SHARD_UNAVAILABLE / NORMAL_COMPLETION / POLICY_TERMINATED

## 보안/제한
- 토큰 검증 실패 즉시 종료, audit 로그는 Redis termination context로 남긴다.
- 세션당 입력 rate limit: 초당 30건, 초과 시 `POLICY_TERMINATED`.

## 테스트 맵핑
- `GatewayShardScaleOutTest`에서 재접속/인증 실패/샤드 장애를 검증.
- 추가 WS 통합 테스트는 게이트웨이 프로세스 도입 시 보강.
