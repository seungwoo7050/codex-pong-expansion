# v1.1.0 게이트웨이↔샤드 프로토콜

## 목적
- Redis Streams 기반 게이트웨이-샤드 메시징 구조와 스키마를 고정한다.

## Streams 구조
- 요청 스트림: `game:request:{shardId}` (게이트웨이 → 샤드)
- 응답 스트림: `game:response:{sessionId}` (샤드 → 게이트웨이)
- Consumer group
  - 요청: `cg:gateway` (샤드가 멱등 소비), 응답: 게이트웨이는 단순 `XREAD`.

## 메시지 envelope 필드
- `messageId`(uuid), `type`, `occurredAt`(ISO8601), `sessionId`, `traceId`, `payload`.
- 샤드는 `messageId` 기반으로 멱등 처리, 중복 시 마지막만 유지.

## 요청 타입
- `SESSION_CONNECTED`: payload `{token}`
- `SESSION_RECONNECTED`: `{}`
- `FORWARD_INPUT`: `{direction}`

## 응답 타입
- `SESSION_ACK`: 재접속/신규 모두 동일 ack
- `PLAY_STARTED`: 게임 루프 진입 완료
- `STATE_SNAPSHOT`: `{ball:{x,y},paddle:{left,right}}`
- `TERMINATED`: `{reason}`

## 하트비트/레지스트리
- `shard:registry` hash: `{shardId: {host, updatedAt}}`
- `shard:heartbeat:{shardId}` key with TTL=5s. 게이트웨이는 TTL 만료 시 `SHARD_UNAVAILABLE` 처리.

## 오류/정책
- 멱등성 실패나 payload 유효성 실패 시 샤드는 `TERMINATED{reason=POLICY_TERMINATED}`를 기록하고 게이트웨이가 종료.
- 비활성 shard에 대한 요청 발생 시 게이트웨이가 termination context를 먼저 확인 후 종료 응답만 반환.

## 테스트 근거
- `GatewayShardScaleOutTest`에서 Streams 큐 동작을 인메모리로 대체해 하트비트/종료 정책을 검증한다.
