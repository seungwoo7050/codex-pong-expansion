# v0.8.0 실시간 설계 – 관전자 이벤트/채널

## 1. 개요
- 목표: 플레이어와 관전자를 동일 WebSocket 엔드포인트에서 구분하고, 관전자 대상 지연 브로드캐스트/역할 정보를 표준화한다.
- 범위: `/ws/game` 쿼리 파라미터, 서버→클라이언트 메시지 스키마, 역할별 입력 처리 차이.

## 2. 채널 및 연결 정책
- 엔드포인트: `/ws/game?roomId=<id>&token=<JWT>&role=player|spectator`
  - 기본값: `role` 미지정 시 `player`로 처리.
  - `role=spectator` → 입력 무시, `audienceRole` 필드가 `SPECTATOR`인 메시지 수신.
- 제한/거부
  - 관전자 수가 30명 초과 시 `POLICY_VIOLATION`으로 즉시 종료.
  - 종료된 방 혹은 존재하지 않는 roomId는 `NOT_ACCEPTABLE`로 종료.

## 3. 메시지 포맷
- 서버→클라이언트 `GameServerMessage`
  - 공통 필드: `type`(READY|STATE|FINISHED), `snapshot`(ball/paddle/score), `matchType`, `ratingChange?`(랭크전 결과),
  - 관전 확장: `audienceRole: 'PLAYER'|'SPECTATOR'`, `spectatorCount: number`.
- 클라이언트→서버
  - `INPUT` 메시지는 `audienceRole=PLAYER` 세션만 처리, 관전자 세션은 서버에서 무시.

## 4. 브로드캐스트 타이밍
- 플레이어 세션: 틱마다 즉시 전송(`50ms`) + 경기 종료 시 최종 스냅샷.
- 관전자 세션: 동일 스냅샷을 250ms 지연 후 전송해 네트워크 폭주를 완화.
- READY 메시지는 입장 직후 즉시 발송하며 현재 관전자 수를 포함.

## 5. 오류 및 재연결 지침
- 클라이언트는 `NOT_ACCEPTABLE` 사유 문자열을 그대로 UI에 표시(한국어 안내문 유지).
- 재연결 시 동일 roomId/role로 새 세션을 생성하며, 관전자 한도 초과 시 버튼/토스트로 알림.

## 6. 테스트/검증
- 백엔드 단위 테스트로 관전자 한도 초과 시 false 반환을 검증.
- 프런트 훅 `useGameSocket`이 `audienceRole`/`spectatorCount`를 수신해 상태를 갱신하는지 로컬 시나리오로 확인.
