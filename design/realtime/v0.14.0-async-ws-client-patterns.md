# v0.14.0 잡 진행률 WebSocket 비동기 패턴 정리

## 1. 목적
- v0.14.0에서 요구하는 "중첩 콜백 제거"와 재연결 정책을 표준화하여 잡 진행률 알림의 품질을 보장한다.
- Promise/async 기반 래퍼를 도입해 오류 처리와 재시도 로직을 UI 훅에서 재사용 가능하게 만든다.

## 2. 범위
- 클라이언트: `/ws/jobs` 원시 WebSocket 연결 흐름.
- 적용 대상: `frontend/src/shared/realtime/jobSocketClient.ts`, `frontend/src/hooks/useJobSocket.ts`.
- 제외: 서버 측 STOMP/메시지 포맷 변경(기존 contract 유지).

## 3. 외부 동작
- 연결 주소: `WS_BASE_URL/ws/jobs?token=<JWT>`.
- 상태 이벤트: `connecting` → `connected` → (네트워크 오류 시) `reconnecting` → `disconnected`.
- 메시지 포맷: `{ "type": string, "payload": unknown }` 그대로 UI 콜백으로 전달(파싱 실패 시 경고만 기록).
- 재시도 정책: 최대 3회, 지수형 대기(기본 800ms * 시도 횟수), 초과 시 `disconnected` 알림 후 종료.
- 닫기: UI가 언마운트되면 `close()` 호출로 즉시 종료하며 추가 재시도를 중단.

## 4. 내부 설계
- `startJobSocket(token, onEvent, onStateChange, options)`
  - WebSocket 수명주기를 Promise 체인으로 래핑해 `listenOnce` 실패 시 `connectLoop`가 순차 재시도.
  - onStateChange는 재연결 횟수와 함께 호출되어 UI에서 토스트/배너로 표현 가능.
  - 파싱 예외는 UI를 중단하지 않고 `console.warn`만 남긴다.
- `useJobSocket`
  - React 훅에서 `startJobSocket`을 호출해 연결 상태(`connected`)와 에러 메시지를 노출.
  - 상태가 `reconnecting/disconnected`일 때 한국어 가이드 문구를 반환해 품질 저하를 사용자에게 명확히 알린다.

## 5. 에러/재연결 정책
- 네트워크/토큰 오류로 `onerror` 발생 시 연결이 열리지 않은 상태라면 즉시 실패로 간주하고 재시도.
- 3회 초과 실패 시 더 이상 재연결하지 않으며, UI는 "연결이 끊어졌습니다" 메시지를 표시하고 폴백(수동 새로고침)을 유도.
- 백오프 간격은 옵션으로 주입 가능하여 테스트 환경(짧은 간격)과 실서비스(여유 간격)를 분리할 수 있다.

## 6. 테스트/검증
- 수동: 토큰을 비워 실행 → 즉시 연결 생성 안 됨을 확인. 네트워크를 차단한 상태에서 3회 재시도 후 `disconnected`로 정지하는지 확인.
- 자동: 훅 단위 테스트 대신 `JobsPage.test.tsx`에서 새 `totalItems` 구조를 반영하고 렌더링 회귀를 막음.
- 추후 TODO: Cypress/Playwright 환경에서 WebSocket mock 서버를 붙여 재시도 횟수와 UI 메시지를 계측.
