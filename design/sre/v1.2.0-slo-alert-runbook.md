# v1.2.0 SLO/알림/런북 요약 (Observability & SRE)

## 1. 목표
- API/실시간 경로 모두 traceId로 상관관계를 확보한다.
- 최소 4개 핵심 지표를 운영 가능하도록 수집·알림화한다.
- 장애 Drill과 런북을 연결해 on-call 대응 시간을 단축한다.

## 2. SLI/SLO 정의
| 항목 | 메트릭/수집 방법 | SLI 정의 | SLO 목표 |
| --- | --- | --- | --- |
| WS 연결 성공률 | `realtime.ws.connections{status}` (Micrometer Counter) | 성공 카운터 / (성공+실패) | 99% / 10분 | 
| 매치 시작 성공률 | `realtime.match.start{status}` | 성공 / (성공+실패) | 98% / 15분 |
| API p95 지연 | `http.server.requests` (p95 MeterFilter) | p95 latency (ms) | < 300ms / 5분 |
| Tick loop jitter p95 | `realtime.tick.jitter` Summary p95 | 절대 편차(ms) | < 30ms / 5분 |

보조 SLI: 잡 워커 스팬(OTLP) 오류율, Redis/DB 연결 실패 로그 비율.

## 3. 알림 규칙 (예시)
- WS 연결 성공률 < 99% (2/3 회기) → 경고, 95% 미만 → 치명.
- 매치 시작 성공률 < 98% (연속 3 회기) → 경고.
- API p95 > 300ms (5분 연속) → 경고, > 500ms → 치명.
- Tick jitter p95 > 30ms (3회기) → 경고.
- OTLP 수집 실패 비율 > 5% → 경고 (fallback 로깅 익스포터 확인).

알림 라우팅: 슬랙 `#pong-ops` + 전화(On-call), PagerDuty 규칙은 `runbooks/v1.2.0-drills.md`에 연동.

## 4. 대시보드 구성 (요약)
- Overview: API p95, WS 연결 성공률, 매치 시작 성공률, jitter p95, 최근 경고/이벤트.
- Trace 탐색: `X-Trace-Id` 또는 W3C `traceparent`로 검색, 게이트웨이/샤드/워커 스팬 이름 필터(`gateway.*`, `shard.*`, `worker.*`).
- Drill 뷰: DB/Redis/gateway kill 스크립트 실행 시간대에 맞춰 지표 겹쳐보기.

## 5. 런북 링크
- 공통 드릴/대응 절차: [runbooks/v1.2.0-drills.md](../../runbooks/v1.2.0-drills.md)
- 게이트웨이/샤드 종료 시나리오: `tools/drills/gateway-shard-kill.sh`
- DB/Redis 장애 시나리오: `tools/drills/db-degrade.sh`, `tools/drills/redis-degrade.sh`

## 6. 운영 메모
- OTLP 엔드포인트를 지정하지 않으면 로깅 익스포터가 활성화되어 trace 샘플이 로그에 남는다.
- `X-Trace-Id` 헤더를 클라이언트/테스트에서 강제로 지정하면 동일 traceId로 게이트웨이/샤드/워커까지 이어진다.
- 메트릭 이름은 Prometheus 스크랩 시 동일하게 노출된다(`realtime.*`, `http.server.requests`).
