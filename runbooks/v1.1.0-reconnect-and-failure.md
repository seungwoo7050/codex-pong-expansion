# v1.1.0 재접속/장애 대응 런북

## 목적
- 게이트웨이/샤드 장애 시 종료 정책을 확인하고, 재접속 흐름을 점검하는 절차를 문서화한다.

## 선행 조건
- Redis CLI 접근 가능
- 게이트웨이/샤드 프로세스 로그 확인 가능

## 절차
1. **증상 수집**: 클라이언트 소켓 종료 코드, traceId 확인.
2. **Termination context 조회**: `HGETALL termination:{sessionId}`로 종료 사유 확인.
3. **Shard heartbeat 확인**: `TTL shard:heartbeat:{shardId}` 값이 음수/만료인지 확인.
4. **재접속 테스트**: 동일 토큰으로 재접속 시도. heartbeat 유효하면 `SESSION_ACK`, 아니면 즉시 종료되어야 한다.
5. **정책 종료 확인**: `POLICY_TERMINATED`인 경우 payload/로그에서 악용 원인을 확인 후 차단 정책 업데이트.

## 복구 전략
- shard heartbeat 만료가 반복될 경우 해당 인스턴스를 교체하고 registry에서 제거.
- termination context는 24시간 후 자동 삭제하므로 별도 정리 불필요.

## 검증
- `backend/src/test/java/com/codexpong/backend/realtime/scaleout/GatewayShardScaleOutTest`가 로컬에서 통과하는지 확인.
- 실서비스에서는 WS 통합 테스트 스크립트(로드/재접속)를 실행해 동일 동작을 확인한다.
