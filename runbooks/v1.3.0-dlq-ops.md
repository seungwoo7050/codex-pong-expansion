# v1.3.0 DLQ 운영 절차

## 목적
아웃박스 릴레이 실패로 `dead_letter_events`에 적재된 매치 이벤트를 재처리하거나 폐기하는 절차를 정의한다.

## 사전 확인
- DLQ 레코드 필드: eventId, type, payload(JSON), failedAttempts, lastError, failedAt
- 관련 테이블 상태 확인
  ```sql
  select count(*) from dead_letter_events;
  select eventId, failedAttempts, lastError from dead_letter_events order by failedAt desc;
  ```

## 재처리 절차
1. 문제 원인 제거(소비자 코드 수정, 외부 의존성 복구).
2. 대상 eventId 선택 후 `outbox_events`에 동일 payload 재주입
   ```sql
   -- 기존 DLQ payload를 복사해 outbox_events 상태를 PENDING 으로 재등록
   insert into outbox_events(eventId, type, payload, status, attempts, createdAt, updatedAt)
   select eventId, type, payload, 'PENDING', 0, now(), now() from dead_letter_events where eventId = :id;
   ```
3. 애플리케이션 릴레이가 재시도하도록 대기하거나 `OutboxRelayService.publishPending()` 수동 호출.
4. 소비자 멱등성(`event_consumptions`)을 확인하여 중복 처리가 발생하지 않았는지 검증.

## 폐기 절차
1. 더 이상 유효하지 않은 이벤트면 `dead_letter_events`에서 제거하고 히스토리 남기기
   ```sql
   delete from dead_letter_events where eventId = :id;
   ```
2. 필요 시 감사 로그/티켓에 폐기 사유 기록.

## 주의사항
- 재주입 시 동일 eventId를 유지해야 소비자 멱등성이 정상 동작한다.
- 재시도 전에 소비자 코드가 실패 원인을 해결했는지 확인한다.
- 운영 중에는 배치 크기와 `max-attempts` 설정을 조정할 수 있으나, 변경 시 릴레이 로그를 모니터링한다.
