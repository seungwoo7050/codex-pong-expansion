# v1.2.0 Drill/Runbook

## 공통 준비
- `docker compose up -d` 로컬 또는 동일한 서비스 네트워크에서 실행.
- OTLP 엔드포인트 필요 시 `export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317` 설정.
- 테스트 트래픽은 `X-Trace-Id` 헤더를 고정해 trace 상관관계를 검증한다.

## 1) DB 장애/지연
- 스크립트: `tools/drills/db-degrade.sh`
- 절차: DB stop → 30s 대기 → start.
- 관찰 포인트:
  - `http.server.requests` p95 상승 여부.
  - `realtime.ws.connections{status="failure"}` 증가 여부.
  - trace 뷰에서 `gateway.*` 스팬 오류와 DB 커넥션 예외 로그 확인.
- 복구 확인: DB 재기동 후 1분 내 성공률 회복, 새로운 traceId로 정상 스팬 생성.

## 2) Redis 장애/지연
- 스크립트: `tools/drills/redis-degrade.sh`
- 절차: Redis pause → 20s 대기 → unpause.
- 관찰 포인트:
  - `realtime.match.start{status="failure"}` 및 `realtime.ws.connections` 실패 태그 상승.
  - `shard.*` 스팬에서 TERMINATED 이벤트 traceId 확인.
- 복구 확인: Redis unpause 후 heartbeat 갱신, 새로운 매치 시작 성공률 회복.

## 3) 게이트웨이/샤드 Kill
- 스크립트: `tools/drills/gateway-shard-kill.sh`
- 절차: backend(게이트웨이/샤드 역할) kill → 5s 대기 → start.
- 관찰 포인트:
  - `realtime.ws.connections` 실패 및 종료 응답, `realtime.tick.jitter` 급증 여부.
  - trace 탐색: `gateway.*` 스팬이 중단되고 `TERMINATED` 응답 스팬이 같은 traceId에 묶이는지 확인.
- 복구 확인: 재기동 후 신규 세션에서 성공률 정상화, 알림 해제.

## 알림/대응 노트
- 알림 규칙은 [design/sre/v1.2.0-slo-alert-runbook.md](../design/sre/v1.2.0-slo-alert-runbook.md) 참조.
- Drill 중 치명 알림 발생 시 On-call은 슬랙/전화 모두 확인 후 재시도 또는 롤백을 판단한다.
