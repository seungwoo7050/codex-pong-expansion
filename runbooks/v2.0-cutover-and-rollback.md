# v2.0 Cutover and Rollback Runbook

Scope: Hybrid MSA cutover for identity-service, match-service, and chat-service
behind edge-api.

## Preconditions
- `contracts/services/**/v2.proto` and `contracts/db/db.v2.md` are up to date.
- Services deployable independently with their own DB credentials and schemas.
- Feature flags in edge-api for each domain path (identity, match, chat).
- Observability wired with traceId propagation end-to-end.

## Cutover Steps
1. **Deploy services in shadow mode**
   - Deploy identity-service, match-service, and chat-service with read-only
     shadow traffic (edge-api still serves legacy path).
   - Enable trace sampling and compare outputs in logs/metrics.
2. **Prime caches**
   - edge-api and realtime-gateway fetch identity key set via `GetKeySet` and
     confirm local validation works without remote calls.
3. **Gradual enablement**
   - Toggle feature flags per domain to route a small cohort (e.g., 5%) to gRPC
     implementations.
   - Monitor error rates, latency, and trace continuity.
4. **Full cutover**
   - Increase cohort to 100% once metrics are stable and smoke tests pass.
   - Freeze legacy tables for the migrated domains.
5. **Outbox validation (match-service)**
   - Confirm `PersistMatchResult` writes to match_outbox with traceId for later
     relay (required for v2.1 onward).

## Smoke / Validation
- Run `scripts/contract-test.sh` (proto compile + OpenAPI validation when
  available).
- Run `scripts/migration-test.sh` for schema ownership sanity checks.
- Run `scripts/test-all.sh` for unit/integration coverage.
- Run `scripts/smoke.sh` (login → match → history) with feature flags enabled.
- Verify at least one trace shows continuity from edge-api → service → DB/outbox.

## Rollback Plan
- **Traffic toggle:** use the same feature flags to route traffic back to legacy
  in edge-api; realtime shard disables gRPC call and reverts to legacy path if
  available.
- **Data safety:** keep legacy tables read-only during rollback window; no direct
  writes from other services to owning schemas.
- **Configuration:** retain cached verification keys for existing sessions even
  when routing back to legacy to avoid auth regressions.
- **Verification:** rerun `scripts/smoke.sh` and confirm metrics return to prior
  baselines.

## Post-Cutover
- Remove legacy code paths once stability window passes and rollback risk is
  low; update documentation and disable flags.
